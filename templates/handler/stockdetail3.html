<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
{% load staticfiles %}
{% load compress %}
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> <title>amStock Example</title>
        <link rel="stylesheet" href="http://www.amcharts.com/lib/3/style.css" type="text/css">
        <script src="http://www.amcharts.com/lib/3/amcharts.js" type="text/javascript"></script>
        <script src="http://www.amcharts.com/lib/3/serial.js" type="text/javascript"></script>
        <script src="http://www.amcharts.com/lib/3/amstock.js" type="text/javascript"></script>
        <script src="http://www.amcharts.com/lib/3/themes/none.js" type="text/javascript"></script>
        <link rel="stylesheet" href="//code.jquery.com/ui/1.11.2/themes/smoothness/jquery-ui.css">
        <script src="//code.jquery.com/jquery-1.10.2.js"></script>
        <script src="//code.jquery.com/ui/1.11.2/jquery-ui.js"></script>
        {% compress js %}
        <script type="text/javascript">//<![CDATA[
        window.onload=function(){
            AmCharts.ready(function () {
                    alert("loading page");

                generateChartData();
                generateCollectiveData();
                createPieChart();
            });

            var pieChart;
            var stockChart;
            var chartData = [];
            var collectiveData = [];

            function generateChartData() {
                var data = [];
                // populate stock data as init
                {% for item in stockitem %}
                    {% for it in item.datalist %}
					    data.unshift({
                            "date": new Date("{{ it.date.isoformat }}"),
                            "stockopen": {{ it.open }},
                            "stockclose": {{ it.close }},
                            "stockhigh": {{ it.high }},
                            "stocklow": {{ it.low }},
                            "stockprice": {{ it.close }},
                            "stockvolume": {{ it.volume }},
                            "traderprice": 0,
                            "traderbuyvolume": 0,
                            "tradersellvolume": 0,
                            "event": ""
                        });
                    {% endfor %}
                {% endfor %}
                // populate trader data as update
                {% for item in traderitem %}
                    {% for it in item.datalist %}
                        var date = new Date("{{ it.date.isoformat }}");
                        var result = jQuery.grep(data, function(e){ return e.date == date; });
                        if (result.length != 0) {
                            result[0].traderprice = {{ it.price }};
                            result[0].traderbuyvolume = {{ it.volume }};
                            result[0].tradersellvolume = {{ it.volume }};
                        }
                    {% endfor %}
                    var unit = {
                        "traderid": "{{ item.traderid }}",
                        "stockid": "{{ item.stockid }}",
                        "url": "",
                        "description": "",
                        "data": data
                    }
                    chartData.push(unit);
                {% endfor %}
            }


            function generateCollectiveData(){
                for (var x in chartData) {
                    var dataPoint = chartData[x];
                    if (0 == x) {
                        for (var y in dataPoint.data) {
                            collectiveData.push({
                                "date": dataPoint.data[y].date,
                                    "traderbuyvolume": dataPoint.data[y].traderbuyvolume,
                                    "tradersellvolume": dataPoint.data[y].tradersellvolume,
                                    "tradersumvolume": dataPoint.data[y].tradersumvolume,
                                    "traderprice": dataPoint.data[y].traderprice * dataPoint.data[y].tradersumvolume,
                                    "stockvolume": dataPoint.data[y].stockvolume,
                                    "stockprice": dataPoint.data[y].stockprice
                            });
                        }
                    } else {
                        for (var y in dataPoint.data) {
                            collectiveData[y].traderbuyvolume += dataPoint.data[y].traderbuyvolume;
                            collectiveData[y].tradersellvolume += dataPoint.data[y].tradersellvolume;
                            collectiveData[y].tradersumvolume += dataPoint.data[y].tradersumvolume;
                            collectiveData[y].traderprice += dataPoint.data[y].traderprice * dataPoint.data[y].tradersumvolume;
                        }
                    }
                }
                for (var x in collectiveData) {
                    collectiveData[x].traderprice = Math.floor(collectiveData[x].traderprice / collectiveData[x].tradersumvolume);
                }
            }


            function createPieChart() {
                pieChart = AmCharts.makeChart("chartdiv1", {
                    "type": "pie",
                        "dataProvider": chartData,
                        "valueField": "tradervolume",
                        "titleField": "traderid",
                        "labelText": "[[title]]: [[value]]",
                        "legend": {
                        "markerType": "circle",
                            "position": "right",
                            "marginRight": 80,
                            "autoMargins": false
                    },
                        "pullOutOnlyOne": true
                });
            }

//            function createStockChart() 
//                stockChart = AmCharts.makeChart("chartdiv2", {
//                    "type": "serial",
//                        "theme": "none",
//                        "pathToImages": "http://www.amcharts.com/lib/3/images/",
//                        "dataProvider": collectiveData,
//                        "legend": {
//                        "equalWidths": false,
//                            "useGraphSettings": true
//                        },
//                        "valueAxes": [{
//                            "id": "volumeAxis",
//                            "axisAlpha": 0,
//                            "gridAlpha": 0,
//                            "position": "left",
//                            "title": "volume",
//                            "stackType": "regular"
//                            }, {
//                            "id": "priceAxis",
//                            "axisAlpha": 0,
//                            "gridAlpha": 0,
//                            "inside": true,
//                            "position": "right",
//                            "title": "price"
//                        }],
//                        "graphs": [{
//                            "balloonText": "[[value]]",
//                            "dashLengthField": "dashLength",
//                            "fillAlphas": 0.7,
//                            "legendPeriodValueText": "[[value]]",
//                            "legendValueText": "v: [[value]]",
//                            "title": "traderbuyvolume",
//                            "type": "column",
//                            "valueField": "traderbuyvolume",
//                            "valueAxis": "volumeAxis"
//                            }, {
//                            "balloonText": "[[value]]",
//                            "dashLengthField": "dashLength",
//                            "fillAlphas": 0.7,
//                            "legendPeriodValueText": "[[value]]",
//                            "legendValueText": "v: [[value]]",
//                            "title": "tradersellvolume",
//                            "type": "column",
//                            "valueField": "tradersellvolume",
//                            "valueAxis": "volumeAxis"
//                            }, {
//                            "balloonText": "[[value]]",
//                            "dashLengthField": "dashLength",
//                            "fillAlphas": 0.7,
//                            "legendPeriodValueText": "[[value]]",
//                            "legendValueText": "v: [[value]]",
//                            "title": "stockvolume",
//                            "type": "column",
//                            "newStack": true,
//                            "valueField": "stockvolume",
//                            "valueAxis": "volumeAxis"
//                            }, {
//                            "balloonText": "p:[[value]]",
//                            "bullet": "round",
//                            "bulletBorderAlpha": 1,
//                            "useLineColorForBulletBorder": true,
//                            "bulletColor": "#FFFFFF",
//                            "bulletSizeField": "townSize",
//                            "dashLengthField": "dashLength",
//                            "descriptionField": "event",
//                            "labelPosition": "right",
//                            "labelText": "[[event]]",
//                            "legendValueText": "p: [[value]]",
//                            "title": "traderprice",
//                            "fillAlphas": 0,
//                            "valueField": "traderprice",
//                            "valueAxis": "priceAxis"
//                            }, {
//                            "balloonText": "p: [[value]]",
//                            "bullet": "round",
//                            "bulletBorderAlpha": 1,
//                            "useLineColorForBulletBorder": true,
//                            "bulletColor": "#FFFFFF",
//                            "bulletSizeField": "townSize",
//                            "dashLengthField": "dashLength",
//                            "descriptionField": "event",
//                            "labelPosition": "right",
//                            "labelText": "[[event]]",
//                            "legendValueText": "p: [[value]]",
//                            "title": "stockprice",
//                            "fillAlphas": 0,
//                            "valueField": "stockprice",
//                            "valueAxis": "priceAxis"
//                        }],
//                        "chartCursor": {
//                        "categoryBalloonDateFormat": "WW",
//                            "cursorAlpha": 0.1,
//                            "cursorColor": "#000000",
//                            "fullWidth": true,
//                            "valueBalloonsEnabled": false,
//                            "zoomable": false
//                        },
//                        "dataDateFormat": "YYYY-MM-DD",
//                        "categoryField": "date",
//                        "categoryAxis": {
//                        "dateFormats": [{
//                            "period": "DD",
//                                "format": "DD"
//                        }, {
//                            "period": "WW",
//                                "format": "MMM DD"
//                        }, {
//                            "period": "MM",
//                                "format": "MMM"
//                        }, {
//                            "period": "YYYY",
//                                "format": "YYYY"
//                        }],
//                            "parseDates": true,
//                            "autoGridCount": false,
//                            "axisColor": "#555555",
//                            "gridAlpha": 0.1,
//                            "gridColor": "#FFFFFF",
//                            "gridCount": 50
//                        },
//                        "exportConfig": {
//                        "menuBottom": "20px",
//                            "menuRight": "22px",
//                            "menuItems": [{
//                            "icon": 'http://www.amcharts.com/lib/3/images/export.png',
//                                "format": 'png'
//                        }]
//                        },
//                        "chartScrollbar": {},
//                        "chartCursor": {
//                        "cursorPosition": "mouse"
//                        },
//                });
//
////            function callbackPieChart() 
//                pieChart.addListener("pullOutSlice", function (event) {
//                    stockChart.dataProvider = event.dataItem.dataContext.data;
//                    stockChart.validateData();
//                    stockChart.animateAgain();
//                });
//
//                PieChart.addListener("pullInSlice", function (event) {
//                    stockChart.dataProvider = collectiveData;
//                    stockChart.validateData();
//                    stockChart.animateAgain();
//                });
        }//]]>  
        </script>
        {% endcompress %}
    </head>
	<body style="background-color:#FFFFFF">
        <div id="chartdiv1" style="width:100%; height:600px;"></div>
		<div id="chartdiv2" style="width:100%; height:600px;"></div>
	</body>
</html>
